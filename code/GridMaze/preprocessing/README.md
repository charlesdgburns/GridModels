# Preprocessing

This package translates raw data from grid maze experiments to a standardised processed data format.

## Folder Structure

Raw, preprocessed, and analysis data are all sorted in a top-level 'data' folder, together with an experiment_info.json file, which contains general experiment infomation, including: subject_IDs, maze structures, maze_measurements, dates, goal_subsets, etc. 
```
├── data/
    │   ├── raw_data/
    │   ├── processed_data/
    │   ├── analysis_data/
    │   └── experiment_info.json
```
### Processed Data
The processed data folder contains the version of the data that should be used as the starting point for analyses or for data sharing.  The data structure is designed to be straightforward to understand and work with, while also minimising data duplication to keep the size manageable. 

The processed data folder is organised by subject and session:

```
├── processed_data/
    │   ├── subject1/
    │   │   ├── 2023-03-28-135012/
    │   │   │   ├── session.info.json
    │   │   │   ├── spikes.clusters.npy
    │   │   │   ├── spikes.times.npy
    │   │   │   ├── clusters.metrics.htsv
    │   │   │   ├── frames.tracking.htsv
    │   │   │   ├── frames.trajectories.htsv 
    │   │   │   ├── frames.trailInfo.htsv 
    │   │   │   ├── trials.htsv
    │   │   │   └── events.htsv 
    │   │   ├── 2023-03-29-143423/
    │   │   └── 2023-03-30-133715/     
    │   ├── subject2/
    │   └── subject3/
```
Session folder names are determined by the session's start date and time . We adopt [IBL naming conventions](https://doi.org/10.1101/827873) where applicable for filenames, which are structured as: `object.attribute.filetype`.  In the IBL convention, all files which correspond to the same object share the same first dimension, so e.g. for all the `frames` object files, each row corresponds to one frame of the video.  

### Raw Data

This folder contains separate folders for different streams of raw data. We also put Kilosort, DeepLabCut output in `raw_data`, as they are not yet in the format that they will be used for analysis.

```
├── raw_data/
    │   ├── ephys/
    │   ├── pycontrol/
    │   ├── video/
    │   ├── LFP/
    │   ├── kilosort/
    │   └── DeepLabCut/
```

Each of these raw data folders contains folder/file formatting native to the method of data collection.

### Analysis data

The analysis data folder is used for temporary files generated by analysis code.  These files are not intended to be shared, and their structure and names may change as the analysis code is updated.

## **Processed Data Files**

### File formats:

All processed data files use standard formats that are widely supported by different programming languages.  These are:

- `.npy`  [Numpy](https://numpy.org/doc/stable/reference/generated/numpy.lib.format.html) files used to represent arrays of numerical data.  They can be loaded into Python with `numpy.load('file_path')`.

- `.htsv` Tab separated value files with a one row header indicating the column names, used to represent data tables containing heterogeneous data types.  These can be loaded into Python as a [Pandas](https://pandas.pydata.org/) dataframe with `pandas.read_csv('file_path', sep='\t')`.  They are human readable if opened in a text editor, or using a tabular data viewer app (e.g. [Tad](https://www.tadviewer.com/)).

- `.json` [JSON](https://www.json.org) (Java script object notation) files store dictionary-like collections of key-value pairs.  They can be loaded into python as dictionaries using the  [JSON python module](https://docs.python.org/3/library/json.html) with:

  ```python
  with open('file_path', 'r') as json_file:
      data = json.loads(json_file.read())
  ```

### Units:

All times recorded in processed data files are measured in seconds from the start of the pycontrol session. All other measurements, eg. position coordinates, speed, velocity, etc. are measured in SI units where applicable. 

### File types:

The processed data folder for each session contains the following file types:

- _session.info.json_
    - contains general information about the session, including: subject_ID, maze_structure, maze_number, day_on_maze, goals etc. 
- _spikes.clusters.npy_
    - cluster_id corresponding to each spike
- _spikes.times.npy_
    - time corresponding to each spike
- _clusters.metrics.htsv_
    - Kilosort label ('good' or 'mua') assigned to each cluster
- _frames.tracking.htsv_
    - body part positions (x,y in meters) on each frame 
- _frames.trajectories.htsv_
    - time, head direction, centroid position, velocity, speed, simple_maze position & skeleton_maze position on each frame
    - .interpolated columns indicate where values have been interpolated (1: interpolated, 0: measured value)
- _frames.trailInfo.htsv_
    - trial number, trial phase (inter trial interval, navigation, reward consumption etc.) and current goal  on each frame
- _trials.htsv_
    - goal, errors, and event times (cue, reward, end reward consumption, ITI_start and end_trial) for each trial
- _events.htsv_ 
    - [pyControl](https://pycontrol.readthedocs.io/en/latest/) state entries, events and print lines.


## **Preprocessing Code**
Processed data is generated by the `populate_processed_data` module.  This module calls on functions in other preprocessing modules to process pycontrol, ephys and frames data separately. To generate all processed data from raw data simply run this module using  ``` __name__ == '__main__' ```. 

Note that the `populate_processed_data` module relies on an `experiment_info.json` file, which can be created with the `get_experiment_info_json` module, and the `get_sessions_data_directory` module, which organises all the raw data filepaths associated with each session.   The preprocessing code assumes a given organisation of data in the raw data folder so may need modification to work with new datasets.



